---
- name: Build bulk request payload
  set_fact:
    bulk_request:
      packages: "{{ packages }}"
      force: False

- name: Post bulk install request to Kibana
  uri:
    url: "http://{{ kibana_host }}:{{ kibana_port }}/api/fleet/epm/packages/_bulk"
    method: POST
    headers:
      kbn-xsrf: "true"
      Authorization: "Basic {{ (elastic_username + ':' + elastic_password) | b64encode }}"
    body: "{{ bulk_request | to_json }}"
    status_code: [200, 201, 409]
    body_format: json