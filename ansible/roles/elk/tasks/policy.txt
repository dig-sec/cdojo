
- name: Create an Agent Policy for system monitoring
  uri:
    url: "http://{{ kibana_host }}:{{ kibana_port }}/api/fleet/agent_policies?sys_monitoring=true"
    method: POST
    body_format: json
    body:
      name: "Agent policy 1"
      description: ""
      namespace: "default"
      monitoring_enabled: ["logs", "metrics"]
      inactivity_timeout: 1209600
      is_protected: false
    headers:
      kbn-xsrf: "true"
      Authorization: "Basic {{ (elastic_username + ':' + elastic_password) | b64encode }}"
    status_code: [200, 201]
  register: agent_policy

- name: Debug Agent Policy creation
  debug:
    var: agent_policy

- name: Ensure Fleet Server Package Policy is present
  uri:
    url: "http://{{ kibana_host }}:{{ kibana_port }}/api/fleet/package_policies"
    method: POST
    body_format: json
    body:
      package:
        name: "fleet_server"
        version: "1.5.0"
      name: "fleet_server-1"
      namespace: ""
      description: ""
      policy_id: "{{ agent_policy.json.item.id }}"
      vars: {}
      inputs:
        - type: "fleet-server"
          enabled: true
          vars:
            custom: ""
          streams: {}
    headers:
      kbn-xsrf: "true"
      Authorization: "Basic {{ (elastic_username + ':' + elastic_password) | b64encode }}"
    status_code: [200, 201, 409]  # Allow success, created, and conflict status codes
  register: create_fleet_server_policy
  ignore_errors: yes

- name: Debug Fleet Server Package Policy creation
  debug:
    var: create_fleet_server_policy
